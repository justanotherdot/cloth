#!/bin/sh -eu

API_URL="${API_URL:-https://cloth-api.justanotherdot.workers.dev}"
FRONTEND_URL="${FRONTEND_URL:-https://5061005f.cloth-frontend.pages.dev}"

echo "üöÄ Testing deployment integrity..."
echo "API: $API_URL"
echo "Frontend: $FRONTEND_URL"

# Test 1: Frontend HTML structure
echo -n "1. Frontend HTML structure... "
if curl -sf "$FRONTEND_URL" | grep -q '<html lang="en">' && \
   curl -sf "$FRONTEND_URL" | grep -q 'modulepreload'; then
    echo "‚úÖ PASS"
else
    echo "‚ùå FAIL - Invalid HTML structure"
    exit 1
fi

# Test 2: Assets load correctly
echo -n "2. CSS assets load... "
CSS_URL=$(curl -s "$FRONTEND_URL" | grep -o '/assets/root-[^"]*\.css' | head -1)
if [ -n "$CSS_URL" ] && curl -sf "$FRONTEND_URL$CSS_URL" >/dev/null; then
    echo "‚úÖ PASS"
else
    echo "‚ùå FAIL - CSS asset not loading"
    exit 1
fi

# Test 3: JavaScript assets load
echo -n "3. JavaScript assets load... "
JS_URL=$(curl -s "$FRONTEND_URL" | grep -o '/assets/entry\.client-[^"]*\.js' | head -1)
if [ -n "$JS_URL" ] && curl -sf "$FRONTEND_URL$JS_URL" >/dev/null; then
    echo "‚úÖ PASS"
else
    echo "‚ùå FAIL - JavaScript asset not loading"
    exit 1
fi

# Test 4: API CORS headers
echo -n "4. API CORS headers... "
if curl -sI "$API_URL/api/flags" | grep -q "access-control-allow-origin"; then
    echo "‚úÖ PASS"
else
    echo "‚ùå FAIL - Missing CORS headers"
    exit 1
fi

# Test 5: API response format
echo -n "5. API response format... "
if curl -sf "$API_URL/api/flags" | grep -q '{"flags":' && \
   curl -sf "$API_URL/api/flags" | jq . >/dev/null 2>&1; then
    echo "‚úÖ PASS"
else
    echo "‚ùå FAIL - Invalid API response format"
    exit 1
fi

# Test 6: Security headers
echo -n "6. Security headers... "
if curl -sI "$FRONTEND_URL" | grep -q "x-content-type-options: nosniff" && \
   curl -sI "$FRONTEND_URL" | grep -q "referrer-policy"; then
    echo "‚úÖ PASS"
else
    echo "‚ùå FAIL - Missing security headers"
    exit 1
fi

# Test 7: Performance (basic)
echo -n "7. Response times... "
FRONTEND_TIME=$(curl -o /dev/null -s -w '%{time_total}' "$FRONTEND_URL")
API_TIME=$(curl -o /dev/null -s -w '%{time_total}' "$API_URL/health")

if [ "$(echo "$FRONTEND_TIME < 3.0" | bc -l 2>/dev/null || echo 1)" -eq 1 ] && \
   [ "$(echo "$API_TIME < 1.0" | bc -l 2>/dev/null || echo 1)" -eq 1 ]; then
    echo "‚úÖ PASS"
else
    echo "‚ùå FAIL - Slow response times (Frontend: ${FRONTEND_TIME}s, API: ${API_TIME}s)"
fi

echo ""
echo "‚úÖ All deployment tests passed!"