#!/bin/sh -eu

API_URL="${API_URL:-https://cloth-api.justanotherdot.workers.dev}"
FRONTEND_URL="${FRONTEND_URL:-https://cloth-frontend.justanotherdot.workers.dev}"

echo "Running smoke tests on deployed dual Workers..."
echo "API Worker: $API_URL"
echo "Frontend Worker: $FRONTEND_URL"

# Test API health
echo -n "1. API health check... "
if curl -sf "$API_URL/health" >/dev/null; then
    echo "PASS"
else
    echo "FAIL"
    exit 1
fi

# Test public API endpoint (no auth required)
echo -n "2. Public flag evaluation endpoint... "
if curl -sf "$API_URL/api/flags/test-flag/evaluate" | grep -q '"key"'; then
    echo "PASS"
else
    echo "FAIL"
    exit 1
fi

# Test protected API endpoint returns 401 without auth
echo -n "3. Protected API endpoint requires auth... "
if curl -s "$API_URL/api/flags" | grep -q '401\|Unauthorized' || \
   curl -sI "$API_URL/api/flags" | grep -q "401\|WWW-Authenticate"; then
    echo "PASS"
else
    echo "FAIL - Should require authentication"
    exit 1
fi

# Test frontend serves static assets
echo -n "4. Frontend serves static assets... "
if curl -sf "$FRONTEND_URL" | grep -q '<html'; then
    echo "PASS"
else
    echo "FAIL"
    exit 1
fi

# Test API CORS headers for cross-origin requests
echo -n "5. API CORS headers... "
if curl -sI "$API_URL/api/flags/test-flag/evaluate" | grep -qi "access-control-allow-origin"; then
    echo "PASS"
else
    echo "FAIL - CORS not configured"
    exit 1
fi

echo ""
echo "All smoke tests passed!"