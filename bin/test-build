#!/bin/sh -eu

echo "Testing dual Worker build integrity..."

# Navigate to git project root
PROJECT_ROOT="$(git rev-parse --show-toplevel)"
cd "$PROJECT_ROOT"

# Test Worker build
printf "1. Worker build succeeds... "
if (cd cloth-api && cargo check) >/dev/null 2>&1; then
    echo "PASS"
else
    echo "FAIL"
    exit 1
fi

cd "$PROJECT_ROOT/cloth-frontend"

# Test frontend build
printf "2. Frontend builds without errors... "
if npm run build >/dev/null 2>&1; then
    echo "PASS"
else
    echo "FAIL"
    exit 1
fi

# Test static assets
printf "3. SPA index.html generated... "
if [ -f "build/client/index.html" ]; then
    echo "PASS"
else
    echo "FAIL - build/client/index.html not found"
    exit 1
fi

printf "4. Required assets generated... "
if find build/client/assets -name "*.js" | grep -q "entry.client" && \
   find build/client/assets -name "*.css" | grep -q "root"; then
    echo "PASS"
else
    echo "FAIL - Missing entry.client.js or root.css"
    exit 1
fi

printf "5. Asset references in index.html... "
if grep -q "entry.client" build/client/index.html && \
   grep -q "modulepreload" build/client/index.html; then
    echo "PASS"
else
    echo "FAIL - index.html missing asset references"
    exit 1
fi

printf "6. SPA mode configuration... "
if grep -q '"isSpaMode":true' build/client/index.html; then
    echo "PASS"
else
    echo "FAIL - SPA mode not enabled"
    exit 1
fi

printf "7. No hardcoded localhost URLs... "
if ! grep -r "localhost:" build/client/ 2>/dev/null; then
    echo "PASS"
else
    echo "FAIL - Found hardcoded localhost URLs"
    exit 1
fi

cd "$PROJECT_ROOT"
echo ""
echo "All build tests passed!"