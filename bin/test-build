#!/bin/sh -eu

echo "ğŸ—ï¸  Testing build integrity..."

# Navigate to git project root
PROJECT_ROOT="$(git rev-parse --show-toplevel)"
cd "$PROJECT_ROOT/frontend"

# Test 1: Build succeeds
echo -n "1. Frontend builds without errors... "
if npm run build >/dev/null 2>&1; then
    echo "âœ… PASS"
else
    echo "âŒ FAIL"
    exit 1
fi

# Test 2: index.html generated with SPA mode
echo -n "2. SPA index.html generated... "
if [ -f "build/client/index.html" ]; then
    echo "âœ… PASS"
else
    echo "âŒ FAIL - build/client/index.html not found"
    exit 1
fi

# Test 3: Required assets present
echo -n "3. Required assets generated... "
if find build/client/assets -name "*.js" | grep -q "entry.client" && \
   find build/client/assets -name "*.css" | grep -q "root"; then
    echo "âœ… PASS"
else
    echo "âŒ FAIL - Missing entry.client.js or root.css"
    exit 1
fi

# Test 4: index.html contains proper asset references
echo -n "4. Asset references in index.html... "
if grep -q "entry.client" build/client/index.html && \
   grep -q "modulepreload" build/client/index.html; then
    echo "âœ… PASS"
else
    echo "âŒ FAIL - index.html missing asset references"
    exit 1
fi

# Test 5: SPA mode enabled in generated JS
echo -n "5. SPA mode configuration... "
if grep -q '"isSpaMode":true' build/client/index.html; then
    echo "âœ… PASS"
else
    echo "âŒ FAIL - SPA mode not enabled"
    exit 1
fi

# Test 6: No hardcoded URLs in build
echo -n "6. No hardcoded localhost URLs... "
if ! grep -r "localhost:" build/client/ 2>/dev/null; then
    echo "âœ… PASS"
else
    echo "âŒ FAIL - Found hardcoded localhost URLs"
    exit 1
fi

cd ..
echo ""
echo "âœ… All build tests passed!"