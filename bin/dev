#!/bin/sh -eu

echo "Starting Cloth development environment (dual Workers)..."

# Navigate to git project root
PROJECT_ROOT="$(git rev-parse --show-toplevel)"
cd "$PROJECT_ROOT"

# Check if wrangler is available
if ! command -v wrangler >/dev/null 2>&1; then
    echo "Error: wrangler CLI not found. Install with: npm install -g wrangler"
    exit 1
fi

# Check if we're already in dev mode
if pgrep -f "wrangler dev" >/dev/null 2>&1; then
    echo "Wrangler dev servers already running"
    exit 0
fi

echo "Starting API Worker dev server..."
cd cloth-api && wrangler dev --port 8787 --local &
API_PID=$!
cd "$PROJECT_ROOT"

echo "Starting Frontend Worker dev server..."  
cd cloth-frontend && wrangler dev --port 3000 --local &
FRONTEND_PID=$!
cd "$PROJECT_ROOT"

echo ""
echo "Development servers started:"
echo "  API Worker: http://localhost:8787"
echo "  Frontend Worker: http://localhost:3000"
echo ""
echo "API Authentication: admin / dev123"
echo ""
echo "Process IDs: API=$API_PID, Frontend=$FRONTEND_PID"
echo ""
echo "Press Ctrl+C to stop all servers"

# Wait for interrupt
trap "echo 'Stopping dev servers...'; kill $API_PID $FRONTEND_PID; exit 0" INT TERM
wait $API_PID $FRONTEND_PID