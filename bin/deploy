#!/bin/sh -eu

echo "Deploying Cloth (dual Workers) to Cloudflare..."

# Navigate to git project root
PROJECT_ROOT="$(git rev-parse --show-toplevel)"
cd "$PROJECT_ROOT"

# Check if wrangler is available
if ! command -v wrangler >/dev/null 2>&1; then
    echo "Error: wrangler CLI not found. Install with: npm install -g wrangler"
    exit 1
fi

# Check authentication
if ! wrangler whoami >/dev/null 2>&1; then
    echo "Error: Not authenticated with Cloudflare. Run: wrangler login"
    exit 1
fi

echo "1. Deploying API Worker..."
cd cloth-api && wrangler deploy --env production
cd "$PROJECT_ROOT"

echo "2. Deploying Frontend Worker..."
cd cloth-frontend && wrangler deploy --env production
cd "$PROJECT_ROOT"

echo "Deployment complete!"
echo ""
echo "API Worker: https://cloth-api.justanotherdot.workers.dev"
echo "Frontend Worker: https://cloth-frontend.justanotherdot.workers.dev"
echo ""
echo "API Authentication (for control plane):"
echo "  Username: admin"
echo "  Password: Set AUTH_PASSWORD in Cloudflare dashboard"
echo ""
echo "Public endpoints:"
echo "  Frontend: https://cloth-frontend.justanotherdot.workers.dev"
echo "  Flag evaluation: https://cloth-api.justanotherdot.workers.dev/api/flags/{key}/evaluate"